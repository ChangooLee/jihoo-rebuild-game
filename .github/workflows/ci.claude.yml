name: Claude Auto-Upgrade CI

on:
  workflow_dispatch:
    inputs:
      target:
        description: '업그레이드 대상 (예: performance, a11y, bugfix)'
        required: false
        default: 'auto'
        type: choice
        options:
          - auto
          - performance
          - a11y
          - bugfix
          - dx
  schedule:
    # 매주 월요일 오전 9시 (UTC)
    - cron: '0 9 * * 1'
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main

jobs:
  quality-gate:
    name: 품질 게이트 검증
    runs-on: ubuntu-latest
    
    steps:
      - name: 체크아웃
        uses: actions/checkout@v4
      
      - name: Node.js 설정
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: pnpm 설치
        uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: 설정 및 의존성 설치
        run: |
          chmod +x skills/*.sh
          bash skills/setup.sh
      
      - name: 품질 게이트 검증
        run: bash skills/verify.sh
      
      - name: 아티팩트 업로드 (리서치/로그)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: docs-artifacts
          path: |
            docs/research/**
            docs/logs/**
          retention-days: 30

  auto-upgrade:
    name: Claude 자가 업그레이드
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    
    steps:
      - name: 체크아웃
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Node.js 설정
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: pnpm 설치
        uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: 설정 및 의존성 설치
        run: |
          chmod +x skills/*.sh
          bash skills/setup.sh
      
      - name: Claude Code 작업
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "⚠️  이 단계는 Claude Code가 수동으로 실행해야 합니다."
          echo "아래 명령어를 사용하여 업그레이드를 수행하세요:"
          echo "  1. /plan <목표>"
          echo "  2. skills/research.sh <검색어>"
          echo "  3. 변경 구현"
          echo "  4. skills/verify.sh"
          echo "  5. /pr <제목>"
          echo ""
          echo "현재는 자동화되지 않았습니다. 향후 Claude API를 통한 자동화를 고려하세요."
      
      - name: 품질 게이트 검증
        run: bash skills/verify.sh
      
      - name: 아티팩트 업로드
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: upgrade-artifacts
          path: |
            docs/research/**
            docs/logs/**
            docs/CHANGELOG.md
          retention-days: 30

