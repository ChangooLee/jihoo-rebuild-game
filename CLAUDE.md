본 문서는 **Claude Code**가 `jihoo-rebuild-game`을 스스로 개선(자가 업그레이드)하고, 변경사항을 **PR**로 제출하는 표준 운영 가이드입니다.  
목표는 “말 잘하는 봇”이 아니라 **최종 PR의 품질**입니다.

---

## 0) 핵심 원칙

1. **결과 지향**: 커밋/PR이 품질 기준을 통과할 때만 변경을 제안합니다.
2. **작게, 자주**: 한 번에 하나의 명확한 개선(버그 수정/리팩토링/의존성/UX 개선 등).
3. **재현 가능**: 모든 변경은 `skills/verify.sh`로 **지역/CI에서 동일하게 재현**되어야 합니다.
4. **리서치 우선**: 웹 리서치 → 가설 → PoC → 검증 → 반영 → 회고(Log) 순서를 지킵니다.
5. **문맥 절약**: 필요한 컨텍스트만 읽고, 긴 로그는 `docs/logs/`에 요약 저장 후 링크합니다.

---

## 1) 역할(Agents) & 태스크 흐름

- **Main Agent: `JihooCode`**
  - 전체 맥락 파악, 계획 수립, 태스크 쪼개기, 품질 게이트 확인, PR 생성까지 책임집니다.
- **Task Clones: `Task(...)`**
  - 서브에이전트 대신 **Task 복제본**으로 병렬/분리 작업을 수행합니다.
  - 예: `Task(리팩토링-게임루프)`, `Task(접근성-키보드내비게이션)` 등

> 서브에이전트 생성은 지양합니다. 컨텍스트 단절과 경직된 워크플로우를 유발합니다. 필요한 경우에만 `Task(...)` 복제 전략을 사용하세요.

---

## 2) 컨텍스트 운용

- 기본: 레포 루트, `package.json`, 빌드/테스트 스크립트, `src/`, `docs/`, `README.md`, `CONTRIBUTING.md`
- 긴 파일/로그는 직접 붙이지 말고 `docs/logs/YYYY-MM-DD-<topic>.md`로 저장 후 링크하세요.
- 필요 시 `/catchup`으로 변경 파일만 재독합니다.
- 불필요한 자동 압축/요약은 피하고, **명시적 요약 파일**을 남깁니다.

---

## 3) 슬래시 커맨드(권장 최소 세트)

- `/catchup` : 변경 파일만 다시 읽기
- `/plan <한 줄 목표>` : 짧은 목표와 단계별 계획(1~5단계)
- `/pr <제목>` : 현재 변경을 PR로 정리(아래 PR 템플릿 사용)
- `/clear` : 대화 컨텍스트 초기화 후, 문서화 파일을 재로딩

> 커맨드는 최소한으로. 나머지는 자연어로 지시하되, **skills** 스크립트로 실행하세요.

---

## 4) Skills(필수 CLI 래퍼)

> 모든 행동은 가능한 한 **CLI Skill**로 수행하고, 사용법은 간단히 유지합니다.  
> 스크립트는 `bash` 기준이며, 루트 `skills/` 디렉터리에 둡니다.

- `skills/setup.sh`  
  - **역할**: 런타임/패키지 매니저 자동 감지 및 설치  
  - **동작**: `pnpm-lock.yaml`/`yarn.lock`/`package-lock.json`/`bun.lockb` 감지 → `pnpm|yarn|npm|bun` 선택  
  - **출력**: 선택된 러너명을 `./.runner` 파일에 기록
- `skills/verify.sh`  
  - **역할**: 품질 게이트(형식/린트/타입/테스트/빌드) 일괄 검증  
  - **동작**: `skills/setup.sh` → `fmt` → `lint` → `typecheck` → `test` → `build`  
  - **결과**: 실패 시 원인 요약을 출력하고 **커밋/PR 금지**
- `skills/fmt.sh`, `skills/lint.sh`, `skills/typecheck.sh`, `skills/test.sh`, `skills/build.sh`  
  - **역할**: 개별 작업 분리(프로젝트 스크립트에 맞게 내부에서 `pnpm|yarn|npm|bun run <task>` 호출)
- `skills/upgrade_deps.sh`  
  - **역할**: 안전 범위 내 의존성 업데이트(주요 버전 업은 별도 브랜치)  
  - **권장**: `npx npm-check-updates -u` 또는 러너별 대체 도구 사용 → `skills/verify.sh`
- `skills/research.sh`  
  - **역할**: **웹 리서치 자동화**(오픈 검색엔진/공식문서/OSS 이슈)  
  - **입력**: 질의어  
  - **출력**: `docs/research/YYYY-MM-DD-<slug>.md`에 핵심 링크/요약/적용 아이디어/라이선스 주의점 기록  
  - **주의**: 유료/폐쇄 문서 스크랩 금지, 출처/날짜 반드시 기재
- `skills/gen_changelog.sh`  
  - **역할**: 변경 요약 생성 → `docs/CHANGELOG.md` 갱신(Keep a Changelog 포맷 권장)

> 스킬은 **오류 발생 시 비-제로 종료코드**로 실패를 명확히 신호합니다. Claude Code는 실패 원인을 요약만 하고, 무리한 재시도 대신 계획을 수정하세요.

---

## 5) 품질 게이트(Hooks)

- **쓰기 차단 금지**, 대신 **커밋/PR 단계에서 게이트**:
  1) 변경 전: 가능하면 `skills/test.sh`로 빠른 검증
  2) 커밋 전/PR 전: 반드시 `skills/verify.sh`
  3) 실패 시: 커밋하지 말고 원인/대안/리서치 링크를 `docs/logs/`에 저장 → 계획 수정
- 힌트 훅: 포맷/접근성/성능 체크리스트를 **비차단** 코멘트로 남깁니다.

---

## 6) 자가 업그레이드 플레이북(웹 리서치 포함)

> 매주 또는 사람이 수동 트리거 시 실행(실행 주기는 CI에서 제어).

### 단계
1. **문제/기회 정의**  
   - 예: “초기 로딩 30% 단축”, “키보드 포커스 링 개선”, “게임 루프 메모리 압박 해소”
2. **웹 리서치 (`skills/research.sh`)**  
   - 키워드 예: *‘react game loop optimize’, ‘canvas accessibility’, ‘vite code splitting’, ‘a11y keyboard navigation SPA’*  
   - 결과 파일에 **출처/날짜/라이선스**와 **적용 가능성**을 정리
3. **계획 수립(`/plan`)**  
   - 3~5단계의 작고 안전한 변경으로 쪼개기(실험 → 반영 → 검증)
4. **구현**  
   - 필요한 경우 `Task(...)`로 병렬 처리. 대규모 변경은 **모듈 단위 브랜치** 분리.
5. **검증(`skills/verify.sh`)**  
   - 실패 시 재시도보다 **원인 문서화** 후 다른 접근을 선택
6. **PR 생성(`/pr`)**  
   - 아래 템플릿으로 PR 본문 작성 → `docs/research/…`/`docs/logs/…` 링크 첨부
7. **회고**  
   - `docs/UPGRADE_LOG.md`에 요약 5줄 이내로 추가

---

## 7) 변경 범주(우선순위)

1. **버그/회복탄력성**: 크래시, 렌더링/상태 레이스, 메모리/CPU 스파이크
2. **접근성(a11y)**: 키보드 탐색, 명확한 포커스, ARIA 롤/레이블, 대비/폰트 크기
3. **성능**: 초기 번들, 코드 스플리팅, 이미지/폰트 최적화, 애니메이션 비용
4. **DX/QA**: 타입 안정성, 테스트 커버리지, 린트/포맷 일관성
5. **게임성**: 보상 루프/피드백/난도 곡선(리서치+실험 기반의 소규모 변경)

---

## 8) PR 템플릿(Claude가 이 구조로 작성)

```

### 요약

* (한 줄) 이번 PR은 무엇을 해결/개선합니까?

### 변경 내용

* [ ] 코드/구조
* [ ] 접근성
* [ ] 성능
* [ ] 의존성
* [ ] 문서/로그

### 리서치 근거

* 문서: <docs/research/2025-11-04-...md>
* 핵심 링크(3개 이하): …
* 디자인 트레이드오프: …

### 검증

* 실행: `skills/verify.sh` ✅
* 수치/증거(가능 시): 번들 크기/CLS/LCP/메모리/프레임타임 등

### 리스크 & 롤백

* 리스크: …
* 롤백 절차: `git revert <sha>` + 이전 설정 복원

### 체크리스트

* [ ] 접근성 체크리스트 통과
* [ ] 라이선스 확인(3rd-party 코드/에셋)
* [ ] 사용자 관점 스크린샷/짧은 영상(가능 시)

```

---

## 9) GitHub Actions 통합(개요)

> 별도 워크플로 파일 예: `.github/workflows/ci.claude.yml` (CI에서 구현).  
> 여기는 **Claude가 지켜야 할 규칙**만 기술합니다.

- 트리거
  - 수동(`workflow_dispatch`)
  - 스케줄(cron: 주 1회)
  - 라벨 기반(예: `auto-upgrade`)
- 잡 단계(예시)
  1) 체크아웃 → 런타임 준비
  2) **Claude Code 작업 단계**: 계획 수립 → `skills/research.sh` → 구현 → `skills/verify.sh` → `/pr`
  3) 아티팩트 업로드: `docs/research/*`, `docs/logs/*`
- 품질 정책
  - `skills/verify.sh` 실패 시 PR 금지
  - 변경 범주는 “7) 변경 범주”에 한정
  - 민감 파일(시크릿/환경설정)은 변경 금지

---

## 10) 보안/시크릿 관리

- **Anthropic API 키는 커밋/로그/문서에 절대 포함하지 마세요.**
- GitHub → Settings → Secrets and variables → **Actions** → New repository secret  
  - Name: `ANTHROPIC_API_KEY`  
  - Value: (사용자 보유 키 입력)
- 워크플로 파일에서는 `secrets.ANTHROPIC_API_KEY`로만 참조
- Claude는 키/토큰/쿠키/개인 데이터가 보이면 **즉시 중단**하고 보고 후 파일에서 제거합니다.

---

## 11) 금지/주의 목록

- 대규모 리라이트/의존성 교체(PR 하나에 담지 않기)
- 비공식/불분명 라이선스 코드 가져오기
- 테스트/빌드 깨진 상태로 커밋/PR
- 사용자 행동 데이터 수집 코드 추가(명시 정책/동의 없이)
- 접근성/성능을 악화시키는 시각 효과 추가

---

## 12) 빠른 시작(Claude가 따를 절차)

1. `/catchup` → 변경 파일만 읽기  
2. `/plan "예: 초기 로딩 단축 30%"` → 3~5단계 계획  
3. `skills/research.sh "react code splitting game canvas a11y"`  
4. 변경(필요 시 `Task(...)` 복제)  
5. `skills/verify.sh` 통과 시 `/pr "feat: 초기 로딩 개선 (code-split)"`  
6. `docs/UPGRADE_LOG.md`에 5줄 요약 추가

---

## 13) 폴더 규칙(권장)

- `docs/research/` : 웹 리서치 결과(날짜/출처/적용 아이디어/라이선스 주의)
- `docs/logs/` : 긴 로그/비교표/실험 요약
- `docs/CHANGELOG.md` : 변경 이력(Keep a Changelog)
- `scripts/`, `skills/` : CI/개발 자동화 스크립트(실행 권한 필요)

---

## 14) 접근성/성능 체크리스트(요약)

- **a11y**: 키보드 전 경로 탐색 가능, 포커스 표시, ARIA 롤/레이블, 대비 ≥ WCAG AA
- **성능**: 초번들 최소화, 코드 스플리팅, 이미지/폰트 최적화, 렌더/이펙트 최소화, 메모리 릭 없음
- **DX**: 타입 에러 0, 린트 경고 0, 테스트 안정

---

## 15) 실패 시 행동

- 동일 접근 무한 재시도 금지. 실패 원인 `docs/logs/…`에 문서화 → 대안 제시
- 원인 유형 분류(설계/도구/데이터/리소스/권한) → 각기 다른 해결책 제안
- 필요하면 변경을 **분할**하여 리스크를 낮추고 재도전

---