# FSRS-001 Research: FSRS Card Type Safety

**Date**: 2025-11-05
**Task ID**: FSRS-001
**Goal**: Improve type safety in FSRS engine implementation

---

## Current State

### Code Analysis (apps/web/modules/fsrs/engine.ts)
- ‚úÖ No `as any` found in the code (acceptance criteria already met)
- ‚ö†Ô∏è Manual type definition: `type SchedulingResult = Record<Rating, { card: Card; log?: unknown }>`
- ‚ö†Ô∏è Type assertion: `fsrs.repeat(card, now) as SchedulingResult`
- ‚úÖ Card type properly imported from 'fsrs.js'

### Current Implementation
```typescript
import { FSRS, Card, Rating } from 'fsrs.js';

// Manual type definition
type SchedulingResult = Record<Rating, { card: Card; log?: unknown }>;

// Type assertion used
const schedulingCards = fsrs.repeat(card, now) as SchedulingResult;
```

---

## Research Findings

### fsrs.js Library (v1.0.0)
**Official Repository**: https://github.com/open-spaced-repetition/fsrs.js
**License**: MIT
**Last Updated**: 2024 (stable release)

### Key Types from fsrs.js

Based on the library's TypeScript definitions:

1. **Card**: Core FSRS card type with scheduling state
   - Properties: `due`, `stability`, `difficulty`, `elapsed_days`, `scheduled_days`, `reps`, `lapses`, `state`
   - Fully typed interface

2. **Rating**: Enum for review outcomes
   - `Rating.Again = 1`
   - `Rating.Hard = 2`
   - `Rating.Good = 3`
   - `Rating.Easy = 4`

3. **RecordLog**: Return type of `fsrs.repeat()`
   - Structure: `Record<Rating, { card: Card; log: RecordLogItem }>`
   - `RecordLogItem` contains: `rating`, `state`, `due`, `stability`, `difficulty`, `elapsed_days`, `last_elapsed_days`, `scheduled_days`, `review`

### Type Safety Improvements

The official type from fsrs.js is:
```typescript
RecordLog = Record<Rating, {
  card: Card;
  log: RecordLogItem;
}>
```

Our current manual definition can be replaced with the official type if available.

---

## Recommendations

### Option A: Import Official Types (Preferred)
If fsrs.js v1.0.0 exports `RecordLog` type:
```typescript
import { FSRS, Card, Rating, RecordLog } from 'fsrs.js';

// Use official type instead of manual definition
const schedulingCards: RecordLog = fsrs.repeat(card, now);
```

### Option B: Enhance Manual Type (If exports not available)
```typescript
// More precise type definition
interface RecordLogItem {
  card: Card;
  log: {
    rating: Rating;
    state: CardState;
    due: Date;
    stability: number;
    difficulty: number;
    elapsed_days: number;
    last_elapsed_days: number;
    scheduled_days: number;
    review: Date;
  };
}

type SchedulingResult = Record<Rating, RecordLogItem>;
```

### Option C: Check Package Exports (Recommended First Step)
1. Verify what types are exported from 'fsrs.js'
2. Check if type declarations exist in node_modules
3. Use exported types if available

---

## Implementation Plan

1. ‚úÖ Verify no `as any` exists (ALREADY DONE)
2. üîÑ Check fsrs.js package for exported types
3. üîÑ Replace manual `SchedulingResult` with official types if available
4. üîÑ Ensure type assertions are minimized
5. üîÑ Add JSDoc comments for clarity

---

## Risk Assessment

**Risk Level**: ÎÇÆÏùå (Low)

**Reasons**:
- No `as any` to remove (main acceptance criteria met)
- Existing code is already reasonably type-safe
- Changes are purely type-level refinements
- No runtime behavior changes

**Potential Issues**:
- fsrs.js may not export all internal types
- May need to keep manual type definitions if library doesn't export them

---

## References

- **fsrs.js GitHub**: https://github.com/open-spaced-repetition/fsrs.js
- **FSRS Algorithm Paper**: https://github.com/open-spaced-repetition/fsrs4anki/wiki/The-Algorithm
- **TypeScript Best Practices**: Prefer imported types over manual definitions
- **Date**: 2025-11-05

---

## License Compliance

‚úÖ **fsrs.js**: MIT License - Compatible with project
‚úÖ **No proprietary code**: All references are to open-source libraries
‚úÖ **Attribution**: Open Spaced Repetition community

---

## Next Steps

Since the acceptance criteria (`! grep -R 'as any' apps/web/modules/fsrs/engine.ts`) is already satisfied, the task focuses on improving type safety by:

1. Checking what types fsrs.js actually exports
2. Using proper imported types instead of manual definitions
3. Removing unnecessary type assertions where possible

The actual improvement will be replacing the manual `SchedulingResult` type with proper imports from fsrs.js.
